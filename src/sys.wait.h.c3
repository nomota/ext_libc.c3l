// sys.wait.h.c3

module c::sys::wait::c;

// Main wait functions
extern fn int wait(int* wstatus);
extern fn int waitpid(int pid, int* wstatus, int options);
extern fn int waitid(IdType idtype, uint id, Siginfo* infop, int options);
extern fn int wait3(int* wstatus, int options, Rusage* rusage);
extern fn int wait4(int pid, int* wstatus, int options, Rusage* rusage);

module c::sys::wait::c::unused;

// Resource usage structure (from sys/resource.h)
struct Timeval {
    long tv_sec;
    long tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}

// Status examination macros as inline functions
macro bool wifexited(int status) => (((status) & 0x7f) == 0);
macro int wexitstatus(int status) => (((status) & 0xff00) >> 8);
macro bool wifsignaled(int status) => ((char)(((status) & 0x7f) + 1) >> 1 > 0);
macro int wtermsig(int status) => ((status) & 0x7f);
macro bool wcoredump(int status) => ((status) & 0x80);
macro bool wifstopped(int status) => (((status) & 0xff) == 0x7f);
macro int wstopsig(int status) => wexitstatus(status);
macro bool wifcontinued(int status) => ((status) == 0xffff);

// Siginfo structure (simplified, actual structure in signal.h)
struct Siginfo {
    int si_signo;
    int si_errno;
    int si_code;
    int si_pid;
    uint si_uid;
    int si_status;
    void* si_addr;
}

// Common constants across platforms
const int WNOHANG = 1;
const int WUNTRACED = 2;
const int WCONTINUED = 8;

// Special pid values
const int WAIT_ANY = -1;
const int WAIT_MYPGRP = 0;

// wait.h.linux.c3
module c::sys::wait::c @if(env::LINUX);

// Options for waitpid/waitid
const int WNOHANG = 1;
const int WUNTRACED = 2;
const int WSTOPPED = 2;
const int WEXITED = 4;
const int WCONTINUED = 8;
const int WNOWAIT = 0x01000000;

// Linux-specific options
const int __WNOTHREAD = 0x20000000;
const int __WALL = 0x40000000;
const uint __WCLONE = 0x80000000;

// Status examination macros
macro bool wifexited(int status) => ((status & 0x7f) == 0);
macro int wexitstatus(int status) => ((status & 0xff00) >> 8);
macro bool wifsignaled(int status) => (((char)((status & 0x7f) + 1) >> 1) > 0);
macro int wtermsig(int status) => (status & 0x7f);
macro bool wcoredump(int status) => ((status) & 0x80) != 0;
macro bool wifstopped(int status) => ((status & 0xff) == 0x7f);
macro int wstopsig(int status) => ((status & 0xff00) >> 8);
macro bool wifcontinued(int status) => (status == 0xffff);

// idtype for waitid
enum IdType : int {
    P_ALL,
    P_PID,
    P_PGID,
    P_PIDFD,
}

// Signal info structure for waitid
struct Siginfo {
    int si_signo;
    int si_errno;
    int si_code;
    union {
        int[28] _pad;
        struct {
            int si_pid;
            uint si_uid;
        }
        struct {
            int si_pid2;
            uint si_uid2;
            int si_status;
            long si_utime;
            long si_stime;
        }
    }
}

// Resource usage
struct Timeval {
    long tv_sec;
    long tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}


// wait.h.darwin.c3
module c::sys::wait::c @if(env::DARWIN);

// Options for waitpid/waitid
const int WNOHANG = 0x00000001;
const int WUNTRACED = 0x00000002;
const int WSTOPPED = WUNTRACED;
const int WEXITED = 0x00000004;
const int WCONTINUED = 0x00000010;
const int WNOWAIT = 0x00000020;

// Status examination macros (Darwin)
macro int _wstatus(int status) => (status & 0x7f);
macro bool wifexited(int status) => (_wstatus(status) == 0);
macro int wexitstatus(int status) => ((status >> 8) & 0xff);
macro bool wifsignaled(int status) => (_wstatus(status) != 0x7f && _wstatus(status) != 0);
macro int wtermsig(int status) => _wstatus(status);
macro bool wcoredump(int status) => ((status & 0x80) != 0);
macro bool wifstopped(int status) => (_wstatus(status) == 0x7f);
macro int wstopsig(int status) => ((status >> 8) & 0xff);
macro bool wifcontinued(int status) => (status == 0x13);

// idtype for waitid
enum IdType : uint {
    P_ALL = 0,
    P_PID = 1,
    P_PGID = 2,
}

// Union for sigval
union Sigval {
    int sival_int;
    void* sival_ptr;
}

// Signal info structure
struct Siginfo {
    int si_signo;
    int si_errno;
    int si_code;
    int si_pid;
    uint si_uid;
    int si_status;
    void* si_addr;
    Sigval si_value;
    long si_band;
    ulong[7] __pad;
}

// Resource usage
struct Timeval {
    long tv_sec;
    int tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}

// wait.h.freebsd.c3
module c::sys::wait::c @if(env::FREEBSD);

// Options for waitpid/waitid
const int WNOHANG = 1;
const int WUNTRACED = 2;
const int WSTOPPED = WUNTRACED;
const int WCONTINUED = 4;
const int WNOWAIT = 8;
const int WEXITED = 16;
const int WTRAPPED = 32;

// FreeBSD specific
const uint WLINUXCLONE = 0x80000000;

// Status examination macros
macro int _wstatus(int status) => (status & 0x7f);
macro bool wifexited(int status) => (_wstatus(status) == 0);
macro int wexitstatus(int status) => ((status >> 8) & 0xff);
macro bool wifsignaled(int status) => (_wstatus(status) != 0 && _wstatus(status) != 0x7f);
macro int wtermsig(int status) => _wstatus(status);
macro bool wcoredump(int status) => ((status & 0x80) != 0);
macro bool wifstopped(int status) => (_wstatus(status) == 0x7f);
macro int wstopsig(int status) => ((status >> 8) & 0xff);
macro bool wifcontinued(int status) => (status == 0x13);

// idtype for waitid
enum IdType : int {
    P_PID = 0,
    P_PPID = 1,
    P_PGID = 2,
    P_SID = 3,
    P_CID = 4,
    P_UID = 5,
    P_GID = 6,
    P_ALL = 7,
    P_LWPID = 8,
    P_TASKID = 9,
    P_PROJID = 10,
    P_POOLID = 11,
    P_JAILID = 12,
    P_CTID = 13,
    P_CPUID = 14,
    P_PSETID = 15,
}

// Union for sigval
union Sigval {
    int sival_int;
    void* sival_ptr;
}

// Signal info structure
struct Siginfo {
    int si_signo;
    int si_errno;
    int si_code;
    int si_pid;
    uint si_uid;
    int si_status;
    void* si_addr;
    Sigval si_value;
    union {
        struct {
            int _trapno;
        }
        struct {
            int _timerid;
            int _overrun;
        }
        struct {
            int _mqd;
        }
        struct {
            long _band;
        }
        struct {
            int _syscall;
        }
        int[7] __spare__;
    }
}

// Resource usage
struct Timeval {
    long tv_sec;
    long tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}

// wait.h.netbsd.c3
module c::sys::wait::c @if(env::NETBSD);

// Options for waitpid/waitid
const int WNOHANG = 0x00000001;
const int WUNTRACED = 0x00000002;
const int WSTOPPED = WUNTRACED;
const int WCONTINUED = 0x00000010;
const int WNOWAIT = 0x00010000;
const int WEXITED = 0x00000020;
const int WTRAPPED = 0x00000040;

// NetBSD specific
const int WALLSIG = 0x00000008;
const int WALTSIG = 0x00000004;

// Status examination macros
macro int _wstatus(int status) => (status & 0x7f);
macro bool wifexited(int status) => (_wstatus(status) == 0);
macro int wexitstatus(int status) => ((status >> 8) & 0xff);
macro bool wifsignaled(int status) => (_wstatus(status) != 0x7f && _wstatus(status) != 0);
macro int wtermsig(int status) => _wstatus(status);
macro bool wcoredump(int status) => ((status & 0x80) != 0);
macro bool wifstopped(int status) => (_wstatus(status) == 0x7f);
macro int wstopsig(int status) => ((status >> 8) & 0xff);
macro bool wifcontinued(int status) => (status == 0xffff);

// idtype for waitid
enum IdType : int {
    P_ALL = 0,
    P_PID = 1,
    P_PGID = 2,
}

// Union for sigval
union Sigval {
    int sival_int;
    void* sival_ptr;
}

// Signal info structure
struct Siginfo {
    int si_signo;
    int si_code;
    int si_errno;
    union {
        int[24] _pad;
        struct {
            int _pid;
            uint _uid;
            Sigval _value;
        }
        struct {
            int _pid2;
            uint _uid2;
            int _status;
            long _utime;
            long _stime;
        }
        struct {
            void* _addr;
            int _trap;
        }
        struct {
            long _band;
            int _fd;
        }
    }
}

// Resource usage
struct Timeval {
    long tv_sec;
    long tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}


// wait.h.openbsd.c3
module c::sys::wait::c @if(env::OPENBSD);

// Options for waitpid/waitid
const int WNOHANG = 0x0001;
const int WUNTRACED = 0x0002;
const int WSTOPPED = WUNTRACED;
const int WCONTINUED = 0x0008;

// Status examination macros
macro int _wstatus(int status) => (status & 0x7f);
macro bool wifexited(int status) => (_wstatus(status) == 0);
macro int wexitstatus(int status) => ((status >> 8) & 0xff);
macro bool wifsignaled(int status) => (_wstatus(status) != 0x7f && _wstatus(status) != 0);
macro int wtermsig(int status) => _wstatus(status);
macro bool wcoredump(int status) => ((status & 0x80) != 0);
macro bool wifstopped(int status) => (_wstatus(status) == 0x7f);
macro int wstopsig(int status) => ((status >> 8) & 0xff);
macro bool wifcontinued(int status) => (status == 0x13);

// idtype for waitid (OpenBSD doesn't have waitid in base system)
enum IdType : int {
    P_ALL = 0,
    P_PID = 1,
    P_PGID = 2,
}

// Union for sigval
union Sigval {
    int sival_int;
    void* sival_ptr;
}

// Signal info structure
struct Siginfo {
    int si_signo;
    int si_code;
    int si_errno;
    union {
        int[29] _pad;
        struct {
            int _pid;
            union {
                struct {
                    uint _uid;
                    Sigval _value;
                }
                struct {
                    long _utime;
                    int _status;
                    long _stime;
                }
            }
        }
        struct {
            void* _addr;
            int _trapno;
        }
        struct {
            long _band;
            int _fd;
        }
    }
}

// Resource usage
struct Timeval {
    long tv_sec;
    long tv_usec;
}

struct Rusage {
    Timeval ru_utime;
    Timeval ru_stime;
    long ru_maxrss;
    long ru_ixrss;
    long ru_idrss;
    long ru_isrss;
    long ru_minflt;
    long ru_majflt;
    long ru_nswap;
    long ru_inblock;
    long ru_oublock;
    long ru_msgsnd;
    long ru_msgrcv;
    long ru_nsignals;
    long ru_nvcsw;
    long ru_nivcsw;
}
